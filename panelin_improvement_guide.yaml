# panelin_improvement_guide.yaml
# Guía para AI agents que mejoren el sistema Panelin

architecture_principles:
  - LLM_NEVER_CALCULATES: "Todo cálculo matemático debe ejecutarse en funciones Python con tipo Decimal"
  - SINGLE_SOURCE_OF_TRUTH: "panelin_truth_bmcuruguay.json es la única fuente de precios"
  - DETERMINISTIC_FIRST: "Preferir herramientas deterministas sobre razonamiento LLM"
  - VALIDATE_EVERYTHING: "Cada output de cálculo debe pasar por verificación"

file_modifications:
  kb_training_system:
    action: "CONSOLIDATE"
    target: "panelin_truth_bmcuruguay.json"
    instructions: |
      - Eliminar archivos KB duplicados
      - Migrar todos los precios a formato standardizado
      - Agregar campo 'calculation_rules' por producto
      - Incluir 'last_sync' timestamp en cada producto
  
  gpt_consolidation_agent:
    action: "SIMPLIFY"
    instructions: |
      - Reducir a single-agent architecture
      - Convertir sub-agents a tool functions
      - Implementar structured output para extracción
      - Agregar validation layer post-extraction
  
  calculation_functions:
    action: "CREATE"
    location: "panelin/tools/quotation_calculator.py"
    instructions: |
      - Usar Decimal para toda aritmética financiera
      - Incluir type hints completos (TypedDict returns)
      - Cargar precios desde JSON KB, nunca hardcodear
      - Agregar 'calculation_verified: True' en outputs
      - Implementar unit tests para cada función

code_patterns:
  tool_definition: |
    # Ejemplo de herramienta correcta
    @tool
    def calculate_panel_quote(
        panel_type: Literal["Isopanel", "Isodec", "Isoroof"],
        thickness_mm: int,
        length_m: float,
        width_m: float, 
        quantity: int,
        discount_percent: float = 0.0
    ) -> QuotationResult:
        """Cálculo determinista - LLM solo extrae parámetros"""
        # ... implementación con Decimal ...
        return result

  llm_configuration: |
    # Configuración óptima para precisión
    llm = ChatOpenAI(
        model="gpt-4o-mini",
        temperature=0,
        model_kwargs={"response_format": {"type": "json_object"}}
    )

  validation_pattern: |
    # Verificación post-cálculo
    def validate_quotation(result: QuotationResult) -> bool:
        assert result['calculation_verified'] == True
        assert result['total_usd'] > 0
        assert result['area_m2'] > 0
        # Verificar que total = sum(line_items)
        return True

testing_requirements:
  - minimum_golden_tests: 50
  - coverage_threshold: 95%
  - required_test_categories:
    - basic_calculations
    - discount_applications  
    - edge_cases_dimensions
    - error_handling
    - shopify_sync_verification
