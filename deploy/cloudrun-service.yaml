# ============================================
# CLOUD RUN SERVICE CONFIGURATION
# Panelin API - Production Deployment
# ============================================
#
# This YAML defines the Cloud Run service configuration
# with all production-grade settings.
#
# Deploy with:
#   gcloud run services replace deploy/cloudrun-service.yaml --region=us-central1
#
# Or use environment-specific files:
#   gcloud run services replace deploy/cloudrun-service-staging.yaml --region=us-central1
#   gcloud run services replace deploy/cloudrun-service-production.yaml --region=us-central1
# ============================================

apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: panelin-api
  labels:
    cloud.googleapis.com/location: us-central1
  annotations:
    # Deployment annotations
    run.googleapis.com/launch-stage: GA
    run.googleapis.com/description: "Panelin API - BMC Uruguay Panel Quotation Service"

spec:
  template:
    metadata:
      annotations:
        # ========================================
        # AUTOSCALING CONFIGURATION
        # ========================================
        # Minimum instances (0 for cost savings, 1+ for low latency)
        autoscaling.knative.dev/minScale: "0"
        # Maximum instances to prevent runaway costs
        autoscaling.knative.dev/maxScale: "10"
        # Target concurrency per instance
        autoscaling.knative.dev/target: "80"
        
        # ========================================
        # STARTUP & HEALTH PROBES
        # ========================================
        # Startup probe timeout (gives container time to start)
        run.googleapis.com/startup-cpu-boost: "true"
        
        # ========================================
        # VPC & NETWORKING (uncomment if needed)
        # ========================================
        # run.googleapis.com/vpc-access-connector: projects/PROJECT_ID/locations/us-central1/connectors/panelin-vpc
        # run.googleapis.com/vpc-access-egress: private-ranges-only

    spec:
      # ========================================
      # SERVICE ACCOUNT
      # ========================================
      # Use dedicated service account with minimal permissions
      serviceAccountName: panelin-api@PROJECT_ID.iam.gserviceaccount.com
      
      # ========================================
      # REQUEST TIMEOUT
      # ========================================
      # Maximum time to process a request (in seconds)
      timeoutSeconds: 300
      
      # ========================================
      # CONTAINER CONCURRENCY
      # ========================================
      # Number of concurrent requests per container
      containerConcurrency: 80
      
      containers:
        - name: panelin-api
          # Image from Artifact Registry
          image: us-central1-docker.pkg.dev/PROJECT_ID/panelin/panelin-api:latest
          
          # ========================================
          # RESOURCE LIMITS
          # ========================================
          resources:
            limits:
              # CPU allocation (1 = 1 vCPU)
              cpu: "1"
              # Memory allocation
              memory: "512Mi"
          
          # ========================================
          # PORTS
          # ========================================
          ports:
            - name: http1
              containerPort: 8080
          
          # ========================================
          # ENVIRONMENT VARIABLES
          # ========================================
          env:
            # Application environment
            - name: APP_ENV
              value: "production"
            
            # Logging level
            - name: LOG_LEVEL
              value: "INFO"
            
            # Enable Cloud Trace
            - name: ENABLE_TRACING
              value: "true"
            
            # Enable metrics
            - name: ENABLE_METRICS
              value: "true"
            
            # Worker configuration
            - name: WORKERS
              value: "1"
            
            # Timeout configuration
            - name: WORKER_TIMEOUT
              value: "120"
            
            # ========================================
            # SECRETS FROM SECRET MANAGER
            # ========================================
            # OpenAI API Key
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: openai-api-key
                  key: latest
            
            # MongoDB Connection URI
            - name: MONGODB_URI
              valueFrom:
                secretKeyRef:
                  name: mongodb-uri
                  key: latest
            
            # MongoDB Database Name (optional secret)
            - name: MONGODB_DB
              value: "panelin"
          
          # ========================================
          # HEALTH PROBES
          # ========================================
          # Startup probe - checks if the container has started
          startupProbe:
            httpGet:
              path: /health
              port: 8080
            # Wait up to 60 seconds for startup
            initialDelaySeconds: 0
            periodSeconds: 5
            failureThreshold: 12
            timeoutSeconds: 5
          
          # Liveness probe - checks if the container is alive
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            # Check every 30 seconds
            periodSeconds: 30
            # Fail after 3 consecutive failures
            failureThreshold: 3
            timeoutSeconds: 10
          
          # Readiness probe - checks if container can accept traffic
          # Note: Cloud Run automatically handles readiness based on liveness
          # but this can be configured for more granular control

  # ========================================
  # TRAFFIC CONFIGURATION
  # ========================================
  traffic:
    - percent: 100
      latestRevision: true
