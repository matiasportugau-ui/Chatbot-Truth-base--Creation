# ============================================
# CLOUD BUILD CONFIGURATION
# Panelin API - Production Deployment
# ============================================
#
# This configuration:
# 1. Runs tests before building
# 2. Builds multi-stage Docker image
# 3. Pushes to Artifact Registry
# 4. Deploys to Cloud Run with proper config
#
# Usage:
#   gcloud builds submit --config=deploy/cloudbuild.yaml
#
# Required substitutions:
#   _PROJECT_ID: GCP Project ID
#   _REGION: Deployment region (default: us-central1)
#   _SERVICE_NAME: Cloud Run service name
#   _ENV: Environment (staging/production)
# ============================================

substitutions:
  _PROJECT_ID: ${PROJECT_ID}
  _REGION: us-central1
  _SERVICE_NAME: panelin-api
  _ENV: production
  _IMAGE_TAG: ${SHORT_SHA}

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'
  dynamic_substitutions: true

steps:
  # ========================================
  # Step 1: Install dependencies and run tests
  # ========================================
  - id: 'test'
    name: 'python:3.11-slim'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        echo "Running linter..."
        pip install ruff
        ruff check --exit-non-zero-on-fix . || echo "Linter warnings found"
        echo "Running tests..."
        pytest -v --tb=short || { echo "Tests failed!"; exit 1; }
    waitFor: ['-']

  # ========================================
  # Step 2: Build Docker image
  # ========================================
  - id: 'build'
    name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/panelin/${_SERVICE_NAME}:${_IMAGE_TAG}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/panelin/${_SERVICE_NAME}:latest'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/panelin/${_SERVICE_NAME}:${_ENV}'
      - '-f'
      - 'deploy/Dockerfile'
      - '--build-arg'
      - 'APP_ENV=${_ENV}'
      - '--cache-from'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/panelin/${_SERVICE_NAME}:latest'
      - '.'
    waitFor: ['test']

  # ========================================
  # Step 3: Push to Artifact Registry
  # ========================================
  - id: 'push'
    name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/panelin/${_SERVICE_NAME}'
    waitFor: ['build']

  # ========================================
  # Step 4: Deploy to Cloud Run
  # ========================================
  - id: 'deploy'
    name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_NAME}'
      - '--image'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/panelin/${_SERVICE_NAME}:${_IMAGE_TAG}'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      # Resource configuration
      - '--memory'
      - '512Mi'
      - '--cpu'
      - '1'
      - '--timeout'
      - '300s'
      - '--concurrency'
      - '80'
      - '--min-instances'
      - '0'
      - '--max-instances'
      - '10'
      # Security: Use IAM for production, public for staging
      - '--no-allow-unauthenticated'
      # Service account with minimal permissions
      - '--service-account'
      - 'panelin-api@${_PROJECT_ID}.iam.gserviceaccount.com'
      # Environment variables
      - '--set-env-vars'
      - 'APP_ENV=${_ENV},LOG_LEVEL=INFO'
      # Secret Manager integration
      - '--set-secrets'
      - 'OPENAI_API_KEY=openai-api-key:latest,MONGODB_URI=mongodb-uri:latest'
      # Labels for organization
      - '--labels'
      - 'env=${_ENV},app=panelin,version=${_IMAGE_TAG}'
      # VPC connector (if needed for private resources)
      # - '--vpc-connector'
      # - 'projects/${_PROJECT_ID}/locations/${_REGION}/connectors/panelin-vpc'
    waitFor: ['push']

  # ========================================
  # Step 5: Verify deployment health
  # ========================================
  - id: 'verify'
    name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Waiting for deployment to stabilize..."
        sleep 30
        
        # Get the service URL
        SERVICE_URL=$(gcloud run services describe ${_SERVICE_NAME} \
          --region=${_REGION} \
          --format='value(status.url)')
        
        echo "Service URL: $SERVICE_URL"
        
        # Check health endpoint (with IAM token for authenticated services)
        TOKEN=$(gcloud auth print-identity-token)
        
        echo "Checking health endpoint..."
        HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
          -H "Authorization: Bearer $TOKEN" \
          "$SERVICE_URL/health")
        
        if [ "$HEALTH_STATUS" = "200" ]; then
          echo "✅ Health check passed!"
        else
          echo "❌ Health check failed with status: $HEALTH_STATUS"
          exit 1
        fi
        
        echo "Checking readiness endpoint..."
        READY_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
          -H "Authorization: Bearer $TOKEN" \
          "$SERVICE_URL/ready")
        
        if [ "$READY_STATUS" = "200" ]; then
          echo "✅ Readiness check passed!"
        else
          echo "⚠️ Readiness check returned: $READY_STATUS"
        fi
        
        echo "Deployment verification complete!"
    waitFor: ['deploy']

# Images to push to Artifact Registry
images:
  - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/panelin/${_SERVICE_NAME}:${_IMAGE_TAG}'
  - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/panelin/${_SERVICE_NAME}:latest'
  - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/panelin/${_SERVICE_NAME}:${_ENV}'

# Build timeout (10 minutes)
timeout: '600s'

# Artifact to store build logs
artifacts:
  objects:
    location: 'gs://${_PROJECT_ID}-build-logs/panelin/${BUILD_ID}'
    paths:
      - 'deploy/cloudbuild.yaml'
