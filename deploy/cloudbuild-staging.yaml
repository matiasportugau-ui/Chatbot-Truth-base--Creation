# ============================================
# CLOUD BUILD CONFIGURATION - STAGING
# Panelin API - Staging Environment
# ============================================
#
# This configuration deploys to staging environment
# with reduced resources and public access for testing.
#
# Usage:
#   gcloud builds submit --config=deploy/cloudbuild-staging.yaml
# ============================================

substitutions:
  _PROJECT_ID: ${PROJECT_ID}
  _REGION: us-central1
  _SERVICE_NAME: panelin-api-staging
  _ENV: staging
  _IMAGE_TAG: ${SHORT_SHA}

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'
  dynamic_substitutions: true

steps:
  # ========================================
  # Step 1: Run tests
  # ========================================
  - id: 'test'
    name: 'python:3.11-slim'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        echo "Running tests..."
        pytest -v --tb=short -x || { echo "Tests failed!"; exit 1; }
    waitFor: ['-']

  # ========================================
  # Step 2: Build Docker image
  # ========================================
  - id: 'build'
    name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/panelin/${_SERVICE_NAME}:${_IMAGE_TAG}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/panelin/${_SERVICE_NAME}:latest'
      - '-f'
      - 'deploy/Dockerfile'
      - '--build-arg'
      - 'APP_ENV=${_ENV}'
      - '.'
    waitFor: ['test']

  # ========================================
  # Step 3: Push to Artifact Registry
  # ========================================
  - id: 'push'
    name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/panelin/${_SERVICE_NAME}'
    waitFor: ['build']

  # ========================================
  # Step 4: Deploy to Cloud Run (Staging)
  # ========================================
  - id: 'deploy'
    name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_NAME}'
      - '--image'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/panelin/${_SERVICE_NAME}:${_IMAGE_TAG}'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      # Staging resource configuration (lower than production)
      - '--memory'
      - '256Mi'
      - '--cpu'
      - '1'
      - '--timeout'
      - '60s'
      - '--concurrency'
      - '40'
      - '--min-instances'
      - '0'
      - '--max-instances'
      - '2'
      # Allow public access for staging testing
      - '--allow-unauthenticated'
      # Service account
      - '--service-account'
      - 'panelin-api@${_PROJECT_ID}.iam.gserviceaccount.com'
      # Environment variables
      - '--set-env-vars'
      - 'APP_ENV=${_ENV},LOG_LEVEL=DEBUG'
      # Secret Manager integration
      - '--set-secrets'
      - 'OPENAI_API_KEY=openai-api-key:latest'
      # Labels
      - '--labels'
      - 'env=${_ENV},app=panelin'
    waitFor: ['push']

  # ========================================
  # Step 5: Verify staging deployment
  # ========================================
  - id: 'verify'
    name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Waiting for deployment..."
        sleep 15
        
        SERVICE_URL=$(gcloud run services describe ${_SERVICE_NAME} \
          --region=${_REGION} \
          --format='value(status.url)')
        
        echo "Staging URL: $SERVICE_URL"
        
        # Health check (public endpoint in staging)
        HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE_URL/health")
        
        if [ "$HEALTH_STATUS" = "200" ]; then
          echo "✅ Staging deployment successful!"
          echo "Test the API at: $SERVICE_URL/docs"
        else
          echo "❌ Health check failed: $HEALTH_STATUS"
          exit 1
        fi
    waitFor: ['deploy']

images:
  - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/panelin/${_SERVICE_NAME}:${_IMAGE_TAG}'
  - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/panelin/${_SERVICE_NAME}:latest'

timeout: '600s'
